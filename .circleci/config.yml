version: 2
jobs:
  build:
    docker:
      - image: diehlpk/teaching
    steps:
      - checkout
      - run: find -name "*.cpp" -exec g++ "{}" -o "{}".exec ";"
      - run: find -name "*.cpp" -exec cppcheck --enable=warning,performance "{}" ";"
      - run: mkdir final
      - run: git submodule update --init --remote ParallelComputationMathExamples/
      - run: 
          command: | 
            latexmk -pdflatex="lualatex --shell-escape %O %S" --jobname=lecture1-slides -pdf lecture1.tex
            latexmk -pdflatex="lualatex --shell-escape --synctex=1 %O '\def\classoption{12.pt,handout}\input{%S}'" --jobname=lecture1-handout -pdf lecture1.tex
      - run: 
          command: | 
            latexmk -pdflatex="lualatex --shell-escape %O %S" --jobname=lecture2-slides -pdf lecture2.tex
            latexmk -pdflatex="lualatex --shell-escape --synctex=1 %O '\def\classoption{12.pt,handout}\input{%S}'" --jobname=lecture2-handout -pdf lecture2.tex
      - run: 
          command: | 
            latexmk -pdflatex="lualatex --shell-escape %O %S" --jobname=lecture3-slides -pdf lecture3.tex
            latexmk -pdflatex="lualatex --shell-escape --synctex=1 %O '\def\classoption{12.pt,handout}\input{%S}'" --jobname=lecture3-handout -pdf lecture3.tex
      - run: 
          command: | 
            latexmk -pdflatex="lualatex --shell-escape %O %S" --jobname=lecture4-slides -pdf lecture4.tex
            latexmk -pdflatex="lualatex --shell-escape --synctex=1 %O '\def\classoption{12.pt,handout}\input{%S}'" --jobname=lecture4-handout -pdf lecture4.tex
      - run: cd syllabus && latexmk -pdflatex="lualatex" -pdf syllabus.tex && cp syllabus.pdf ../final
      - run: cd timetable && latexmk -pdflatex="lualatex" -pdf timetable.tex  && cp timetable.pdf ../final
      - run: cp lecture*.pdf final
      - run: cd webpage && pandoc -s index.md --toc -c pandoc.css -o index.html
      - run: cp webpage/index.html webpage/pandoc.css final
      - store_artifacts:
          path: final
          destination: lectures
